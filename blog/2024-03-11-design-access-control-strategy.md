---
title: 통합 접근 제어 전략을 설계 해보다.
description: 흩어져 하드코딩되어 있는 권한 관리를 하나로 통합하는 설계를 진행해 보았다.
tags:
  - design
hide_table_of_contents: false
toc_max_heading_level: 4
draft: true
---

## Intro

회사에서 내가 맡은 서비스의 **권한 관리**는 여러 곳에 흩어져 하드코딩 되어 있다. 여기서 권한 관리란 어떤 리소스에 대한 접근 권한을 말한다.

이때 고려되는 요소도 다양하다. 그런데 이번에 새 기능이 추가되어 더욱 더 복잡하게 관리해야 할 상황이 생겼다. REST API도 제공하게 되었다. 이에 권한 관리를 한곳에서 통합해야 할 필요가 생겼고, 이 임무가 나에게(!!) 맡겨졌다.

그래서 설계를 해보며 고려한 요소들과, 이 과정에서 느낀점을 정리해 보려고 한다.

<!-- truncate -->

:::warning

조금이라도 민감할 수 있는 회사 내용을 모두 제외하였기 때문에, **앙꼬없는 찐빵**같은 글일 수 있습니다.

`ROLE_` 형식의 권한 설계가 아닌, 다른 설계를 계획할 때 조금이라도 인사이트가 된다면 좋겠습니다. ☺️

:::

## 고려해야 할 요소

사내 서비스는 망 분리가 되어 있다. 그래서 사내직원 / 외부유저가 로그인 방식이 다르고, 접근하는 도메인도 다르다. 사내직원일 경우 부서별로 어떤 리소스에 대한 접근 권한이 다르다. 특정 부서가 생성한 것은 그 부서만 수정할 수 있다던가 하는 처리가 필요하다. 외부유저일 경우 같은 회사만 열람할 수 있었다. 이걸 모두 하드코딩 하고 있었다. (if ~ else로.)

또, 일반적인 웹 백엔드 API 말고도 REST API 로의 접근도 제공하게 되었다. 이때 Token을 발급받은 유저만 해당 API 를 사용할 수 있다.

이런 요소들을 고민해야 했다. 정리하면 아래와 같다.

- 사내직원 (Jira API 에서 로그인 정보를 가져옴) / 외부유저 (회원 관리 DB가 따로 있음)
- 사내직원 일 경우 부서 정보에 따라 접근 권한을 구분해야 함
- 외부유저일 경우 회사 정보에 따라 접근 권한을 구분해야 함

지금까지 부서별 권한을 나누는 일은 없었으나, 이번에 추가되었다. Jira API는 부서 정보를 한글로 된 String으로 반환했다. 만약 조직 개편이 이루어질 경우 **마이그레이션** 도 고려해야 했다.

## 전략의 선택

보통 권한관리 시에 Spring으로 어플리케이션을 개발하면 Spring Security로 Role을 부여하여 하곤 한다. 하지만 나의 경우 권한 관리가 이루어 지는 곳은 Express 였고, 회원 관련 정보가 우리 DB에 있는 것이 아니라 외부로부터 가져오는 정보이기 때문에 흔하게 적용하는 방법을 쉽게 쓸 수 없었다.

권한관리를 설계할 때 어떤 전략을 취하는지 조사를 해 보았다. `Role Based Access Control (역할 기반 제어)` 와 `Attribute Based Access Control (속성 기반 제어)` 가 가장 많이 취하는 전략이였다.

이 두 전략을 중심으로 설계를 했는데, 리뷰 시간에 PL분께서 인사이트를 제공해 주셔서(!) 해당 리소스별로 권한을 제어하는 방식, 내맘대로 `Resource Based Access Control (리소스 기반 제어)` 라 이름을 짓고, 이 전략도 추가로 설계했다.

아, 추가로 권한을 관리할 수 있는 오픈소스들 (OPA 등 ...) 이 있긴 했는데, 개발자가 나 혼자라 서비스를 하나 더 추가해 관리하는것이 부담스럽고 그렇게 큰 시스템도 아니라서 이건 제외했다.

### Role Based Access Control, 역할 기반 접근 제어

#### 특징

역할에 따라 시스템, 리소스에 대한 사용자 접근 권한을 관리하는 방법이다. 각 개별 사용자에 대해 역할을 부여하고, 어떤 기능에 대해 허용할 역할을 나열해 제어한다.

역할 기반 접근 제어는 다음 특징을 가진다.

- 각 사용자에게는 하나 이상의 역할이 할당된다.
- 사용자 역할에는 권한이 할당된다.
- 사용자가 역할을 활성 구성원이 되면 권한에 액세스 할 수 있다.

예를들어, 어떤 상품을 판매하는 페이지라면, `ROLE_ADMIN`, `ROLE_SELLER`, `ROLE_USER`와 같은 역할을 정의하고, 그 역할에 따라 제어하게 된다.

**역할 정의**

```json
{
  "name": "roles/testRole",
  "title": "billing role",
  "includedPermissions": ["paymentStatement.list", "usage.list"]
}
```

**역할 부여**

```json
{
  "bindings": [
    {
      "role": "roles/testRole",
      "members": ["user:viewrain@hohoho.com"]
    }
  ]
}
```

#### 장점

- 권한에 대한 부여, 회수가 간편하다. 특정 권한을 부여하려면 역할을 부여하고, 뺏으려면 역할을 제거하면 된다. 따라서 유연하고 직관적인 통제가 가능하다.

#### 단점

- 역할이 폭발적으로 늘어날 수 있다. 새 기능이 추가되고, 그 기능에만 허용되는 권한이 생긴다면 새로 역할을 정의하고 부여한다. 이런식으로 반복하면 서비스가 커질수록 그 역할도 함께 늘어난다.
- 세밀한 권한 정책을 부여할 수 없다.
  - 여러 상황을 추상화해서 역할을 만들지만, 딱 맞는 역할을 정하기가 힘들다. 특정 권한에 대해 많은 고려요소가 있는 경우, 하나만 요소가 바뀌어도 다른 역할을 부여해야 하는데 그렇게 너무 작은 단위로 역할을 나누면 자주 변경하게 될 수 있다.

#### 우리 서비스에는 ...

적용하기 쉽지 않았다. 일단 유저에 대한 DB 정보가 우리한테 있는 것이 아니기 때문에, '회원가입' 이라는 절차가 없어 유저 정보를 기본적으로 가지고 있지 않다.

로그인 한 적 없는 유저가 로그인하면 자동으로 역할을 판단해 부여한다던가 하는 절차가 필요했다.

그리고, 부서별 역할 정의도 필요하고, 회사별 역할 정의도 필요했다. 너무 많은 역할의 정의가 필요했고, 부여하기 위한 별도 로직이 필요했다. 까딱해서 잘못 판단하면 봐야하는 유저가 못보는 정보가 생길 수도 있었다.

이렇게 되니 더욱 복잡해져서 이 전략은 탈락했다.

### Attribute Based Access Control, 속성 기반 접근 제어

#### 특징

주체, 자원 또는 환경의 속성을 기반으로 접근을 제어하는 방식이다. 어떤 사람이 특정 객체에 접근하려 할때 객체의 속성, 사람의 속성, 그때의 환경 정보 등을 다양하게 고려해서 판단한다.

관계는 if ~ then 문으로 정의한다. 예를들면 다음과 같다.

- 직급이 '주임' 이상이고, 접근한 ip주소가 000.000.000.000/ 대역대 이고, 해당 게시물을 작성한 사람이 같은팀 일때 액세스 가능하다.
- 회사 정책에 "토요일 휴무"로 지정되어 있는 경우, 토요일에는 누구도 파일에 액세스할 수 없습니다.
  이런 정책을 모두 if ~ then 문으로 정의하는 것이다.

나는 '정책' 을 저장할 json array를 정의해 하나의 object에는 리소스의 정보와, 접근하려는 유저의 정보, 최종적으로 그것을 allow 할건지 deny 할건지 결정하는 정보를 적어주었다. 예를 들면 다음과 같다.

```json
[
  {
    "id": "policy_1",
    "description": "A 부서가 만든 파일중 aa타입의 파일은 A 부서만 접근할 수 있습니다.",
    "condition": {
      "request": {
        "access": "inner", // 사내직원
        "department": "A"
      },
      "resource": {
        "department": "A",
        "type": "aa"
      }
    },
    "action": "allow"
  }
  // 생략
]
```

이렇게 모든 케이스를 구분해 나열해주는 것이다.

#### 장점

- 굉장히 세밀한 접근 제어가 가능하다. 거의 모든 경우의 수를 통제할 수 있다.
- 따라서 표현성, 유연성이 매우 좋다.

#### 단점

- 시스템 규모가 커지고, 권한에 대한 케이스가 많아질수록 성능 저하가 올 수 있다.
- 정책을 정의하는 데 많은 시간이 필요하다.

#### 우리 서비스에는 ...

리소스에 대한 종류가 다양해, 많은 케이스의 정의가 필요했다. 그렇게되면 매번 모든 정책을 훑어봐야 했다. 부서만 몇십개고, 회사는 몇천개였어서 그 정책을 다 한번씩 보는 것은 성능에 문제가 있었다.

그리고 개발자가 나뿐이라.. 이걸 정의할 사람도 나였고, 실수하게 되면 치명적인 문제가 발생할 것이기 때문에 결국 이것도 탈락했다.

그리고 조직 개편시 마이그레이션도 정책을 모두 살펴보며 String을 찾고 바꿔줘야 하는데, 정책이 많으면 마이그레이션 할때 신뢰성도 떨어지고 오래걸리기 때문에 이건 탈락했다.

### Resource Based Access Control, 리소스 기반 제어 (내맘대로 명칭)

#### 특징

리소스의 유형을 정의하고, 그것에 대해 특정 유저를 거부할건지 허용할건지 설정해주는 방식이다. 예를 들면 다음과 같다. 회사 정보가 아닌 다른 예시라 조금 엉성할수도 있다 ..

```json
[
    "post": {
        "a": {
            "USER|kildong.hong": {
                "allow": [
                    "read"
                ],
                "deny": [
                    "create",
                    "update",
                    "delete"
                ]
            },
            "GROUP|회계팀": {
                // 생략
            },
            "ACCESS|사내직원": {
                // 생략
            }
        }
    }
]
```

이렇게 리소스의 유형을 정의하고, 해당 리소스에 접근할 수 있는 유저와 그 유저에게 허용된 행위 정보를 적어준다.

- a타입 post에 대해 홍길동 유저는 조회 가능하고, 등록 수정 삭제는 할 수 없다.

와 같이 말이다.

#### 장점

얼핏보면 ABAC와 비슷하다고 생각할 수 있는데, 일단 리소스의 타입별로 나누어 성능엔 조금 더 이점이 있을 수 있다. 그리고 user, group, access와 같이 prefix를 정의하고 설정해 유저의 타입을 구분한다. 한눈에 어떤 유저인지, 어떤 타입의 리소스인지 파악이 가능하다. 나중에 설정을 수정하는 어드민 페이지를 개발한다고 해도 이 편이 더 관리하기 쉬울 것이라 생각했다.

#### 단점

이 경우에도 조직개편시 마이그레이션을 하려면 모든 정책을 한번 다 훑어야 한다.

#### 우리 서비스에는 ...

위 전략들을 모두 살펴보았을 때, 복잡한 우리 서비스의 상황에 가장 알맞다고 생각했다. 유저에 대한 DB정보가 디폴트로 없는 환경에서 유저의 접속 정보와 아이디 등만 보고 판단할 수 있는 가장 좋은 방법이라고 생각했다.

따라서 이 전략을 더욱 더 고도화 해 적용하기로 했다.

## 느낀점

모든 전략을 살펴볼 때, 간단한 샘플 코드를 작성했다. 정책을 정의하고, 그것을 판단하는 코드를 작성해보고, 실제로 호출도 해보았다.

그렇게 해보며 내가 글로 적은 설계와 코드간의 차이가 무엇인지 파악할 수 있었고 실현 가능성을 판단하는 데에도 도움이 되었다. 실제 구현했을때 코드가 예쁘게 짜지는지 알 수 있었다.

시간은 좀 더 걸렸을 지라도, 실제로 적용해야 하는 사안이기 때문에 신중히 결정하려면 필요한 과정이였다고 생각한다.

이 설계를 진행하면서 기술적인 부분 말고도, 커뮤니케이션에 대한 깨달음도 있었다. 나와 PL분 둘이서 설계-리뷰를 진행했다. 리뷰를 진행하고 다시 설계를 보완해 오는 과정에서, 리뷰에서의 PL님의 말씀과 나의 이해가 다른 경우가 있었다. 내가 이해한 줄 알았는데, 아니였던 거다. 이걸 확인하는 과정이 없다면 그걸 바탕으로 설계하고, 다른 것을 다음 리뷰때 확인하기 때문에 시간을 낭비하게 되었다.

한번 그런 뒤로는 리뷰 받은 후 내가 이해한 것이 맞는지 정리해서 한번 확인을 요청드렸다. 이렇게 하니까 나도 더 안심이 되었고 쓸데없는 시간 낭비를 줄일 수 있었다.

이 설계를 경험하면서 시스템에 대한 이해도도 더 높아졌다. 그동안은 뭉뚱그려 알고있었던 것들을 확실히 문서로 적어보면서, 정확하게 파악할 수 있었다. 그리고 하드코딩된 소스들을 살펴보며 버그도 발견할 수 있었다.

팀에 웹개발자가 없어(지금은 나뿐,,) 어려울 때도 있지만, 1년차도 안되었는데 이런 설계도 경험할 수 있는 것은 장점이고, 또 내 의견을 표출해볼 수 있는 것도 장점이다. (시간상 못하는게 더 많지만 ..) 아무튼 좋은 경험이였다. 권한이라 함은 무조건 ROLE\_ 이렇게 설정하는 줄 알았는데 새로운 접근 방식을 많이 알게 되었다. 얻어가는 게 꽤 많았던 경험이다.

# 레퍼런스

- https://www.samsungsds.com/kr/insights/cloud_platform_manage.html
- https://www.okta.com/kr/identity-101/role-based-access-control-vs-attribute-based-access-control/
